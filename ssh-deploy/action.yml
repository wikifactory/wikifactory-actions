name: "ssh deploy"
description: 'auto deploy the container'

inputs:
  services_name:
    required: true
    type: string
    is-array: true
  path:
    required: true
    type: string
    description: "where is the docker compose path're"
  deployer_host:
    description: "url host"
    required: true
  deployer_username:
    description: "username"
    required: true
  ci_ssh_key:
    description: "ssh key"
    required: true
  ci_ssh_passphrase:
    required: true

runs:
  using: "composite"
  steps:
    - name: Run production deploy script
      uses: appleboy/ssh-action@master
      with:
        host: ${{ inputs.deployer_host }}
        username: ${{ inputs.deployer_username }}
        key: ${{ inputs.ci_ssh_key }}
        passphrase: ${{ inputs.ci_ssh_passphrase }}
        script: |
          cd ${{ inputs.path }}
          echo "${{ inputs.services_name }}" > /tmp/services_tmp_name
          services_name=$(awk BEGIN{RS=EOF}'{gsub(/\n/," ");print}' /tmp/services_tmp_name)

          docker compose pull $services_name
          docker compose up -d
        command_timeout: 30m